var dadatajs=function(){"use strict";function e(e,t){return t?t.split(".").reduce((e,t)=>"object"==typeof e?e[t]:e,e):e}class t{constructor(e,t,r,n){this.data={},this.fields={},this.model=e,this.name=t,this.fields=r,n&&(this.data=n)}setSource(e){this.data=e,this.model.setProxy(this.name)}}var r;!function(e){e.IS_JSON_RESPONSE=!0,e.QUERY_METHOD="GET",e.CONTAINER_PROXY_PREFIX="$"}(r||(r={}));class n{constructor(e=null){this.processors={},this.modifiers={},this.described_containers={},this.containers={},this.addContainer=function(){if(arguments.length>=2)var e=arguments[0],r=arguments[1],n=arguments[2];else{const t=arguments[0];e=t.name,r=t.fields,n=t.source}let s=this.getExtendedFields(e),i=e;s&&(r=Object.assign({},r,s.extended),i=s.name);let o=new t(this,i,r,n);return this.containers[i]=o,this.setProxy(i),this},this.addContainers=(e=>{Array.isArray(e)&&e.forEach(this.addContainer);for(let t in e){const{fields:r,source:n}=e[t];this.addContainer(t,r,n)}return this}),this.parent=e,this.addFieldProcessorsBulk({int:e=>e&&parseInt(e)?+parseInt(e):0,string:e=>"string"==typeof e?e:e?""+e:"",array:e=>Array.isArray(e)?e:[],bool:e=>!!e,usd:e=>"NaN"!=e.toString()&&e.toString().indexOf("$")<0?e+"$":e,kzt:e=>"NaN"!=e.toString()&&e.toString().indexOf("₸")<0?e+"₸":e})}setProxy(e){if(this.getContainer(e)){let t=this.containers[e].data;this[`${r.CONTAINER_PROXY_PREFIX}${e}`]=t}else console.error(`\n        BaseAjax::setProxy()\n        Container ${e} not found\n      `)}createProcessorCallie(e){let t=e.split(".");return e=>{let r=!1,n=e;for(let e of t)if(e.indexOf(":")>=0){let t=e.split(":"),s=t[0],i=JSON.parse(t[1]);if(this.modifiers[s]){let e=this.modifiers[s](n,i);n=e.value||n,r=e.break||r}if(r)break}else n=this.proceedProcessor(e,n);return n}}getContainer(e){return this.containers[e]}proceedProcessor(e,t){return this.processors[e]?this.processors[e](t):void 0}getExtendedFields(e){if(!!~e.indexOf(" extends ")){let t=e.split(" extends ").map(e=>e.replace(/\s/g,"")),r={};if(~t[1].indexOf("[")){t[1].replace(/[\[\]]/g,"").split(",").forEach(e=>{this.described_containers[e]&&(r=Object.assign({},r,this.described_containers[e]))})}else this.described_containers[t[1]]&&(r=Object.assign({},r,this.described_containers[t[1]]));return{name:t[0],extended:r}}return!1}describeContainer(e,t={}){let r=this.getExtendedFields(e),n=e;return r&&(t=Object.assign({},t,r.extended),n=r.name),this.described_containers[n]=t,this}getProcessor(e){if(~e.indexOf("@")){let t=e.replace("@","").split("."),r=t[0],n=this.getContainer(r);if(n){let e=t.slice(-1).join(""),r=n.fields[e];return~r.indexOf("@")?this.getProcessor(r):r}}return e}addModifier(e){let t=e.name||null,r=e.proc||null;return t&&r?(this.modifiers[t]=r,this):(console.error("\n        BaseAjax::addModifier()\n        You should specify both name and callback\n      "),this)}addFieldProcessor(e){let t=e.name,r=e.proc;return t&&r?(this.processors[t]=r,this):(console.error("\n        BaseModel::addFieldProcessor()\n        You should specify both name and callback\n      "),this)}addFieldProcessorsBulk(e){return this.processors=Object.assign({},this.processors,e),this}addModifiersBulk(e){return this.modifiers=Object.assign({},this.modifiers,e),this}getFieldFromContainer(t,r){let n=this.getContainer(t),s=n?n.data:null;return s||console.error(`BaseModel::getFieldFromContainer() Container ${t} not found`),e(s,r)}generateQuery(e){let t,n=e.uri,s=(e.method||r.QUERY_METHOD).toUpperCase(),i=e.container||null;i&&(t=this.getContainer(i));let o=t?this.getFields(i):e.data||null,a=e.mode,d=e.headers||{},c=e.credentials,u=(e.check,!0===e.json||!1===e.json?e.json:r.IS_JSON_RESPONSE);"GET"==s&&o?(n=n+(~n.indexOf("?")?"&":"?")+function(e){return Object.keys(e).map(t=>Array.isArray(e[t])?e[t].map(e=>e?`${encodeURIComponent(t)}[]=${encodeURIComponent(e)}`:"").join("&"):e[t]?`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`:"").join("&")}(o),o=null):"GET"!=s&&(o=JSON.stringify(o));return()=>new Promise((e,t)=>{let r={headers:Object.assign({},d),credentials:c,method:s,mode:a,body:o},i={uri:n,fetch_params:r};this.beforeFetch&&this.beforeFetch.constructor&&this.beforeFetch.call&&this.beforeFetch.apply&&(i=this.beforeFetch(n,r)),fetch(i.uri,i.fetch_params).then(r=>{this.interceptor&&(this.interceptor(r)||t()),r.ok||t(),u?r.json().then(t=>{e(t)}).catch(()=>{let e=new Error("Json parse error");e.type="json",t(e)}):r.text().then(t=>{e(t)}).catch(()=>{let e=new Error("Text retrieve error");e.type="text",t(e)})}).catch(e=>{t(e)})})}parseCondition(t){let r=t.split(" ");for(let t in r){let n=r[t].split(".");if(n.length){let s=n.slice(1,-1).join("."),i=n.slice(-1).join("");if("^"==n[0]&&(r[t]=e(this.parent,s)[i]),"&"==n[0]&&(r[t]=e(this,s)[i]),"@"==n[0]){let e=n[0].replace("@","");r[t]=this.getFieldFromContainer(e,s)[i]}}}return t=r.join(" "),Function.apply(null,[].concat("return "+t))()}getFields(t){let r=this.getContainer(t);if(!Object.keys(r.fields).length)return console.error("\n        BaseModel::getFields()\n        You have to specify field names\n      "),{};if(!r.fields)return r.data||{};let n={};return Object.keys(r.fields).map(t=>{let s=!~t.indexOf("?"),i=r.data,o=t.replace(/\?/g,""),a=o,d=null,c=null,u=!1,l=t.match(/if\((.+)\)/i),h=!0;if(l&&l.length>1&&(h=this.parseCondition(l[1])),h){if(~t.indexOf(".")){let r=t.split(" ")[0].split(".");if(a=r.slice(-1).join(""),"^"==r[0]||"&"==r[0]||0===r[0].indexOf("@")){u=!0;let t=r.slice(1,-1).join(".");if(0===r[0].indexOf("@")){let e=r[0].replace("@","");i=this.getFieldFromContainer(e,t)}else"^"==r[0]&&this.parent?i=e(this.parent,t):"&"==r[0]&&(i=e(this,t))}i||console.error(`BaseModel::getFields() Field ${t} not found`),c=i[a],o=a}let l=t.replace(/if\((.+)\)/gi,"").trim();if(~l.indexOf(" as ")){let e=l.split(" as ");u||(a=e[0]),o=e[1]}if(d=u?c:i[a],s||!s&&d){let e=this.getProcessor(r.fields[t]),s=this.createProcessorCallie(e);n[o]=s?s(d):d}}}),n}}var s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},d=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},c="undefined"==typeof Promise?require("es6-promise").Promise:Promise,u="https://suggestions.dadata.ru/suggestions/api/4_1/rs",l=["fio","address","party","email","bank"],h={"Content-Type":"application/json",Accept:"application/json"},f={fio:"POST",address:"POST",party:"POST",email:"POST",bank:"POST"},p=["ACTIVE","LIQUIDATING","LIQUIDATED"],y=["LEGAL","INDIVIDUAL"],g=function(e){function t(e,r){s(this,t);var n=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.addHeaders(h),n.setToken(r),n.describeContainer("query",{query:"string.strip:300"}).describeContainer("base extends query",{"count?":"int"}).addContainer("fio extends base",{"parts?":"array","gender?":"string"}).addContainer("address extends base",{"locations?":"array","locations_boost?":"array","from_bound?":"bound","to_bound?":"bound","restrict_value?":"bool"}).addContainer("party extends base",{"status?":"array.party_status","type?":"array.party_types","locations?":"array"}).addContainer("email extends base",{}).addContainer("bank extends base",{"status?":"array.party_status","type?":"array.party_types"}).addContainer("find_address extends query",{}).addContainer("find_party extends query",{"type?":"string.party_types","branch_type?":"string"}).addFieldProcessorsBulk({bound:function(e){return e&&e.value?e:null},party_status:function(e){return p.includes(e)?e:null},party_types:function(e){return y.includes(e)?e:null}}).addModifiersBulk({strip:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{value:e.substr(0,t)}},allow:function(e,t){return{break:!!~t.indexOf(e)}},default:function(e,t){return{value:e||t}}}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,n),i(t,[{key:"beforeFetch",value:function(e,t){return t.headers=o({},t.headers,this.headers),{uri:e,fetch_params:t}}},{key:"addHeaders",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._headers=o({},this._headers,e)}},{key:"setToken",value:function(e){this.token=e,this.addHeaders({Authorization:"Token "+e})}},{key:"suggest",value:function(e,t){return this.getContainer(e)?(this.containers[e].data=o({},t),this.generateQuery({uri:u+"/suggest/"+e,method:f[e],container:e})()):new c(function(t,r){r({error:'Suggestion type "'+e+'" not found'})})}},{key:"detectAddressByIP",value:function(e){return this.generateQuery({uri:u+"/detectAddressByIp",method:"GET",data:{ip:e}})()}},{key:"findById",value:function(e,t){return this.getContainer("find_"+e)?(this.containers["find_"+e].data=o({},t),this.generateQuery({uri:u+"/findById/"+e,method:"POST",container:"find_"+e})()):new c(function(t,r){r({error:'Find by id type "'+e+'" not found'})})}},{key:"checkStatus",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e&&!l.includes(e)?new c(function(t,r){r({error:'Service "'+e+'" not found'})}):this.generateQuery({uri:u+"/status/"+e,method:"GET"})()}},{key:"headers",get:function(){return this._headers||{}},set:function(e){this._headers=e||{}}}]),t}(),b=function(){try{if(isNaN.apply(null,{}))return function(e){return function(){try{return Promise.resolve(e.apply(this,arguments))}catch(e){return Promise.reject(e)}}}}catch(e){}return function(e){return function(){try{return Promise.resolve(e.apply(this,Array.prototype.slice.call(arguments)))}catch(e){return Promise.reject(e)}}}}();var m=function(){function e(t){s(this,e),this.model=new g(this,t),this.token=t,this._suggestions=[]}return i(e,[{key:"suggest",value:b(function(e,t){var r=this,n=arguments;return function(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}(function(){var s,i,a,c=n[2]||null,u=n[3]||{};return s=r.model.suggest(e,o({query:t,count:c},u)),i=function(e){if(e.suggestions)return r._suggestions=[].concat(d(e.suggestions)),r.suggestions;throw new Error("Result is empty")},a?i?i(s):s:(s=Promise.resolve(s),i?s.then(i):s)},function(e){return console.error(e),[]})})},{key:"clearCache",value:function(){var e=[].concat(d(this._suggestions));return this._suggestions.splice(0),e}},{key:"detectAddressByIP",value:function(){return this.model.detectAddressByIP(arguments[0]||null)}},{key:"suggestions",get:function(){return this._suggestions}}]),e}();return window&&(window.DaData=m),m}();
